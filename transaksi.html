<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Transaksi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Transaksi</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#tambahTransaksiModal">Tambah Transaksi</button>
        
        <!-- Tabel Transaksi -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID Transaksi</th>
                    <th>Nama Pelanggan</th>
                    <th>Total Harga</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="transaksiList"></tbody>
        </table>
    </div>

    <!-- Modal Tambah Transaksi -->
    <div class="modal fade" id="tambahTransaksiModal" tabindex="-1" aria-labelledby="tambahTransaksiModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tambahTransaksiModalLabel">Tambah Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="tambahTransaksiForm">
                        <div class="mb-3">
                            <label for="pelangganSelect" class="form-label">Pilih Pelanggan</label>
                            <select id="pelangganSelect" class="form-select" required>
                                <!-- Data pelanggan akan diisi -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="produkSelect" class="form-label">Pilih Produk</label>
                            <select id="produkSelect" class="form-select" required>
                                <!-- Data produk akan diisi -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="jumlahInput" class="form-label">Jumlah</label>
                            <input type="number" id="jumlahInput" class="form-control" min="1" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Tambah ke Keranjang</button>
                    </form>

                    <h4 class="mt-4">Keranjang</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nama Produk</th>
                                <th>Jumlah</th>
                                <th>Harga</th>
                                <th>Total</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="keranjangTable">
                            <!-- Data keranjang akan diisi -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-success" id="simpanTransaksi">Simpan Transaksi</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pelangganList = JSON.parse(localStorage.getItem('pelanggan')) || [];
        let produkList = JSON.parse(localStorage.getItem('produk')) || [];
        let transaksiList = JSON.parse(localStorage.getItem('transaksi')) || [];
        let keranjang = [];

        const pelangganSelect = document.getElementById('pelangganSelect');
        const produkSelect = document.getElementById('produkSelect');
        const keranjangTable = document.getElementById('keranjangTable');
        const transaksiTable = document.getElementById('transaksiList');

        function loadPelanggan() {
            pelangganList.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.text = `${p.nama} (${p.peran})`;
                pelangganSelect.appendChild(option);
            });
        }

        function loadProduk() {
            produkList.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.text = `${p.nama} (Stok: ${p.stok})`;
                produkSelect.appendChild(option);
            });
        }

        function tambahKeKeranjang(event) {
            event.preventDefault();
            const produkId = produkSelect.value;
            const jumlah = parseInt(document.getElementById('jumlahInput').value);

            const produk = produkList.find(p => p.id === produkId);
            if (!produk || produk.stok < jumlah) {
                alert('Stok tidak mencukupi!');
                return;
            }

            keranjang.push({ produkId, jumlah });
            renderKeranjang();
        }

        function renderKeranjang() {
            keranjangTable.innerHTML = '';
            keranjang.forEach((item, index) => {
                const produk = produkList.find(p => p.id === item.produkId);
                const row = `
                    <tr>
                        <td>${produk.nama}</td>
                        <td>${item.jumlah}</td>
                        <td>${produk.harga}</td>
                        <td>${item.jumlah * produk.harga}</td>
                        <td>
                            <button class="btn btn-danger" onclick="hapusDariKeranjang(${index})">Hapus</button>
                        </td>
                    </tr>
                `;
                keranjangTable.insertAdjacentHTML('beforeend', row);
            });
        }

        function simpanTransaksi() {
            const pelangganId = pelangganSelect.value;
            const pelanggan = pelangganList.find(p => p.id === pelangganId);
            const totalHarga = keranjang.reduce((acc, item) => {
                const produk = produkList.find(p => p.id === item.produkId);
                return acc + produk.harga * item.jumlah;
            }, 0);

            transaksiList.push({
                id: `TRX-${Date.now()}`,
                pelanggan: pelanggan.nama,
                totalHarga,
                status: 'Belum Dibayar'
            });

            localStorage.setItem('transaksi', JSON.stringify(transaksiList));
            keranjang.forEach(item => {
                const produk = produkList.find(p => p.id === item.produkId);
                produk.stok -= item.jumlah;
            });
            localStorage.setItem('produk', JSON.stringify(produkList));

            keranjang = [];
            renderTransaksi();
            renderKeranjang();
            alert('Transaksi berhasil disimpan!');
        }

        function renderTransaksi() {
            transaksiTable.innerHTML = '';
            transaksiList.forEach(t => {
                const row = `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.pelanggan}</td>
                        <td>${t.totalHarga}</td>
                        <td>${t.status}</td>
                        <td>
                            <button class="btn btn-primary">Konfirmasi Pembayaran</button>
                        </td>
                    </tr>
                `;
                transaksiTable.insertAdjacentHTML('beforeend', row);
            });
        }

        document.getElementById('tambahTransaksiForm').addEventListener('submit', tambahKeKeranjang);
        document.getElementById('simpanTransaksi').addEventListener('click', simpanTransaksi);

        loadPelanggan();
        loadProduk();
        renderTransaksi();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
